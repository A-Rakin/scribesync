{% extends "base.html" %}

{% block title %}Content Calendar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
<style>
    .calendar-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .fc-event {
        cursor: pointer;
        border-radius: 4px;
        padding: 2px 5px;
        font-size: 0.85em;
        border: none !important;
    }
    .fc-event.twitter { background-color: #1DA1F2; }
    .fc-event.linkedin { background-color: #0077b5; }
    .fc-event.instagram { background-color: #E1306C; }
    .fc-event.published { opacity: 0.8; }
    .fc-event.scheduled { opacity: 1; }
    .fc-event.draft { background-color: #6c757d; }
    .calendar-legend {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .legend-color {
        width: 15px;
        height: 15px;
        border-radius: 3px;
    }
    .calendar-filters {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .calendar-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-number {
        font-size: 1.8rem;
        font-weight: bold;
        display: block;
    }
    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .post-detail-modal .post-content {
        max-height: 200px;
        overflow-y: auto;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
    }
    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    .empty-calendar {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    .empty-calendar i {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .view-switcher {
        display: flex;
        gap: 5px;
    }
    .view-switcher button {
        padding: 5px 15px;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 4px;
        cursor: pointer;
    }
    .view-switcher button.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    .platform-filter {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    .platform-filter label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-header">
    <h2><i class="bi bi-calendar-week"></i> Content Calendar</h2>
    <div class="view-switcher">
        <button class="active" onclick="changeView('dayGridMonth')">Month</button>
        <button onclick="changeView('timeGridWeek')">Week</button>
        <button onclick="changeView('timeGridDay')">Day</button>
        <button onclick="changeView('listMonth')">List</button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="calendar-stats">
    <div class="stat-card">
        <span class="stat-number text-primary" id="totalPosts">0</span>
        <span class="stat-label">Total Posts</span>
    </div>
    <div class="stat-card">
        <span class="stat-number text-warning" id="scheduledPosts">0</span>
        <span class="stat-label">Scheduled</span>
    </div>
    <div class="stat-card">
        <span class="stat-number text-success" id="publishedPosts">0</span>
        <span class="stat-label">Published</span>
    </div>
    <div class="stat-card">
        <span class="stat-number text-info" id="upcomingPosts">0</span>
        <span class="stat-label">Next 7 Days</span>
    </div>
</div>

<!-- Filters -->
<div class="calendar-filters">
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Platform Filter:</label>
                <div class="platform-filter">
                    <label>
                        <input type="checkbox" class="platform-checkbox" value="twitter" checked onchange="filterCalendar()">
                        <i class="bi bi-twitter text-primary"></i> Twitter
                    </label>
                    <label>
                        <input type="checkbox" class="platform-checkbox" value="linkedin" checked onchange="filterCalendar()">
                        <i class="bi bi-linkedin text-primary"></i> LinkedIn
                    </label>
                    <label>
                        <input type="checkbox" class="platform-checkbox" value="instagram" checked onchange="filterCalendar()">
                        <i class="bi bi-instagram text-danger"></i> Instagram
                    </label>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Status Filter:</label>
                <div class="platform-filter">
                    <label>
                        <input type="checkbox" class="status-checkbox" value="scheduled" checked onchange="filterCalendar()">
                        <span class="badge bg-warning">Scheduled</span>
                    </label>
                    <label>
                        <input type="checkbox" class="status-checkbox" value="published" checked onchange="filterCalendar()">
                        <span class="badge bg-success">Published</span>
                    </label>
                    <label>
                        <input type="checkbox" class="status-checkbox" value="draft" checked onchange="filterCalendar()">
                        <span class="badge bg-secondary">Draft</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div class="mb-3">
                <label class="form-label">Date Range:</label>
                <div class="input-group">
                    <input type="date" class="form-control" id="startDate" onchange="filterCalendar()">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" id="endDate" onchange="filterCalendar()">
                    <button class="btn btn-outline-secondary" type="button" onclick="resetDateRange()">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="mb-3">
                <label class="form-label">Search Posts:</label>
                <input type="text" class="form-control" id="searchPosts" placeholder="Search by title or content..." oninput="searchPosts()">
            </div>
        </div>
    </div>
</div>

<!-- Calendar Legend -->
<div class="calendar-legend">
    <div class="legend-item">
        <div class="legend-color" style="background-color: #1DA1F2;"></div>
        <span>Twitter</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #0077b5;"></div>
        <span>LinkedIn</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #E1306C;"></div>
        <span>Instagram</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #6c757d;"></div>
        <span>Draft</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #28a745;"></div>
        <span>Published</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #ffc107;"></div>
        <span>Scheduled</span>
    </div>
</div>

<!-- Calendar Container -->
<div class="calendar-container">
    <div id="calendar"></div>
</div>

<!-- Empty State -->
<div id="emptyCalendar" class="empty-calendar" style="display: none;">
    <i class="bi bi-calendar-x"></i>
    <h4>No posts scheduled yet</h4>
    <p class="mb-4">Schedule your first post to see it appear in your calendar</p>
    <a href="{{ url_for('main.schedule_post') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Schedule Your First Post
    </a>
</div>

<!-- Post Detail Modal -->
<div class="modal fade" id="postDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="postTitle">Post Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th>Platform:</th>
                                <td><span id="modalPlatform" class="badge">Twitter</span></td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td><span id="modalStatus" class="badge">Scheduled</span></td>
                            </tr>
                            <tr>
                                <th>Scheduled Time:</th>
                                <td id="modalTime">-</td>
                            </tr>
                            <tr>
                                <th>Published Time:</th>
                                <td id="modalPublishedTime">-</td>
                            </tr>
                            <tr>
                                <th>Hashtags:</th>
                                <td id="modalHashtags">-</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Engagement</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="display-6" id="modalLikes">0</div>
                                        <small>Likes</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="display-6" id="modalShares">0</div>
                                        <small>Shares</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="display-6" id="modalComments">0</div>
                                        <small>Comments</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <h6>Content:</h6>
                    <div class="post-content" id="modalContent">
                        No content available.
                    </div>
                </div>

                <div class="mt-3" id="modalMediaSection" style="display: none;">
                    <h6>Media:</h6>
                    <div id="modalMedia"></div>
                </div>

                <div class="action-buttons" id="modalActions">
                    <!-- Actions will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editPostBtn">Edit Post</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select posts from:</label>
                    <div class="input-group">
                        <input type="date" class="form-control" id="bulkStartDate">
                        <span class="input-group-text">to</span>
                        <input type="date" class="form-control" id="bulkEndDate">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Platform:</label>
                    <select class="form-select" id="bulkPlatform">
                        <option value="all">All Platforms</option>
                        <option value="twitter">Twitter</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="instagram">Instagram</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Action:</label>
                    <select class="form-select" id="bulkAction">
                        <option value="reschedule">Reschedule</option>
                        <option value="delete">Delete</option>
                        <option value="duplicate">Duplicate</option>
                        <option value="change_platform">Change Platform</option>
                    </select>
                </div>
                <div id="bulkActionDetails" style="display: none;">
                    <!-- Additional fields will be shown based on action -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeBulkAction()">Execute</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script>
let calendar;
let allEvents = [];
let currentPostId = null;

// Initialize calendar
document.addEventListener('DOMContentLoaded', function() {
    // Set default date range (current month)
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

    document.getElementById('startDate').value = formatDate(firstDay);
    document.getElementById('endDate').value = formatDate(lastDay);

    // Initialize calendar
    initCalendar();

    // Load posts
    loadPosts();

    // Update stats
    updateStats();
});

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function initCalendar() {
    const calendarEl = document.getElementById('calendar');

    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
        },
        events: [],
        eventClick: function(info) {
            showPostDetails(info.event.id);
        },
        eventDidMount: function(info) {
            // Add platform icon
            const platform = info.event.extendedProps.platform;
            const status = info.event.extendedProps.status;
            let icon = '';

            switch(platform) {
                case 'twitter': icon = 'ðŸ¦'; break;
                case 'linkedin': icon = 'ðŸ’¼'; break;
                case 'instagram': icon = 'ðŸ“·'; break;
                default: icon = 'ðŸ“';
            }

            // Add status indicator
            let statusIcon = '';
            switch(status) {
                case 'published': statusIcon = 'âœ…'; break;
                case 'scheduled': statusIcon = 'â°'; break;
                case 'draft': statusIcon = 'ðŸ“„'; break;
            }

            info.el.querySelector('.fc-event-title').innerHTML =
                `${icon} ${statusIcon} ${info.event.title}`;
        },
        dayMaxEvents: true,
        navLinks: true,
        editable: true,
        selectable: true,
        selectMirror: true,
        select: function(info) {
            // Redirect to schedule page with pre-filled date
            const dateStr = info.startStr.split('T')[0];
            const timeStr = info.start.toTimeString().split(' ')[0].substring(0, 5);
            window.location.href = `{{ url_for('main.schedule_post') }}?date=${dateStr}&time=${timeStr}`;
        },
        eventDrop: function(info) {
            // Update post schedule time when dragged
            updatePostSchedule(info.event.id, info.event.start);
        },
        eventResize: function(info) {
            // Handle event resize (if needed)
        },
        datesSet: function(info) {
            // Update date range when calendar view changes
            document.getElementById('startDate').value = formatDate(info.start);
            document.getElementById('endDate').value = formatDate(info.end);
            filterCalendar();
        }
    });

    calendar.render();
}

function changeView(view) {
    calendar.changeView(view);
    // Update active button
    document.querySelectorAll('.view-switcher button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

async function loadPosts() {
    try {
        const response = await fetch('/api/posts');
        if (!response.ok) throw new Error('Failed to load posts');

        const posts = await response.json();
        allEvents = posts.map(post => ({
            id: post.id.toString(),
            title: post.title || 'Untitled',
            start: post.scheduled_time || post.created_at,
            className: `fc-event ${post.platform} ${post.status}`,
            extendedProps: {
                platform: post.platform,
                status: post.status,
                content: post.content,
                hashtags: post.hashtags,
                media_url: post.media_url,
                published_at: post.published_at,
                likes: post.likes || 0,
                shares: post.shares || 0,
                comments: post.comments || 0
            }
        }));

        filterCalendar();
        updateStats();

        // Show/hide empty state
        if (allEvents.length === 0) {
            document.getElementById('emptyCalendar').style.display = 'block';
            document.getElementById('calendar').style.display = 'none';
        } else {
            document.getElementById('emptyCalendar').style.display = 'none';
            document.getElementById('calendar').style.display = 'block';
        }

    } catch (error) {
        console.error('Error loading posts:', error);
        alert('Failed to load posts. Please try again.');
    }
}

function filterCalendar() {
    const platformFilters = Array.from(document.querySelectorAll('.platform-checkbox:checked'))
        .map(cb => cb.value);
    const statusFilters = Array.from(document.querySelectorAll('.status-checkbox:checked'))
        .map(cb => cb.value);
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const searchQuery = document.getElementById('searchPosts').value.toLowerCase();

    const filteredEvents = allEvents.filter(event => {
        // Platform filter
        if (!platformFilters.includes(event.extendedProps.platform)) return false;

        // Status filter
        if (!statusFilters.includes(event.extendedProps.status)) return false;

        // Date range filter
        const eventDate = new Date(event.start).toISOString().split('T')[0];
        if (startDate && eventDate < startDate) return false;
        if (endDate && eventDate > endDate) return false;

        // Search filter
        if (searchQuery) {
            const title = (event.title || '').toLowerCase();
            const content = (event.extendedProps.content || '').toLowerCase();
            if (!title.includes(searchQuery) && !content.includes(searchQuery)) return false;
        }

        return true;
    });

    calendar.removeAllEvents();
    calendar.addEventSource(filteredEvents);

    updateStats();
}

function searchPosts() {
    filterCalendar();
}

function resetDateRange() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

    document.getElementById('startDate').value = formatDate(firstDay);
    document.getElementById('endDate').value = formatDate(lastDay);
    filterCalendar();
}

function updateStats() {
    const events = calendar.getEvents();

    // Total posts
    document.getElementById('totalPosts').textContent = allEvents.length;

    // Scheduled posts
    const scheduled = allEvents.filter(e => e.extendedProps.status === 'scheduled').length;
    document.getElementById('scheduledPosts').textContent = scheduled;

    // Published posts
    const published = allEvents.filter(e => e.extendedProps.status === 'published').length;
    document.getElementById('publishedPosts').textContent = published;

    // Upcoming posts (next 7 days)
    const sevenDaysFromNow = new Date();
    sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
    const upcoming = allEvents.filter(e => {
        const eventDate = new Date(e.start);
        return eventDate > new Date() && eventDate <= sevenDaysFromNow;
    }).length;
    document.getElementById('upcomingPosts').textContent = upcoming;
}

function showPostDetails(postId) {
    currentPostId = postId;
    const event = calendar.getEventById(postId);

    if (!event) return;

    const props = event.extendedProps;

    // Set modal content
    document.getElementById('postTitle').textContent = event.title;
    document.getElementById('modalPlatform').textContent = props.platform;
    document.getElementById('modalPlatform').className = `badge bg-${props.platform === 'twitter' ? 'info' : props.platform === 'linkedin' ? 'primary' : 'danger'}`;

    document.getElementById('modalStatus').textContent = props.status;
    document.getElementById('modalStatus').className = `badge bg-${props.status === 'published' ? 'success' : props.status === 'scheduled' ? 'warning' : 'secondary'}`;

    document.getElementById('modalTime').textContent = new Date(event.start).toLocaleString();
    document.getElementById('modalPublishedTime').textContent = props.published_at ?
        new Date(props.published_at).toLocaleString() : 'Not published yet';

    document.getElementById('modalHashtags').innerHTML = props.hashtags ?
        props.hashtags.split(' ').map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('') : 'None';

    document.getElementById('modalContent').textContent = props.content || 'No content available';

    document.getElementById('modalLikes').textContent = props.likes;
    document.getElementById('modalShares').textContent = props.shares;
    document.getElementById('modalComments').textContent = props.comments;

    // Show/hide media section
    const mediaSection = document.getElementById('modalMediaSection');
    const mediaElement = document.getElementById('modalMedia');
    if (props.media_url) {
        mediaSection.style.display = 'block';
        if (props.media_url.match(/\.(jpeg|jpg|gif|png)$/)) {
            mediaElement.innerHTML = `<img src="${props.media_url}" class="img-fluid rounded" alt="Post media">`;
        } else if (props.media_url.match(/\.(mp4|webm|ogg)$/)) {
            mediaElement.innerHTML = `<video src="${props.media_url}" class="img-fluid rounded" controls></video>`;
        } else {
            mediaElement.innerHTML = `<a href="${props.media_url}" target="_blank" class="btn btn-sm btn-outline-primary">View Media</a>`;
        }
    } else {
        mediaSection.style.display = 'none';
    }

    // Set up action buttons
    const actionsDiv = document.getElementById('modalActions');
    actionsDiv.innerHTML = '';

    if (props.status === 'scheduled') {
        actionsDiv.innerHTML += `
            <button class="btn btn-warning btn-sm" onclick="editPost('${postId}')">
                <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-danger btn-sm" onclick="deletePost('${postId}')">
                <i class="bi bi-trash"></i> Delete
            </button>
            <button class="btn btn-info btn-sm" onclick="duplicatePost('${postId}')">
                <i class="bi bi-copy"></i> Duplicate
            </button>
            <button class="btn btn-success btn-sm" onclick="publishNow('${postId}')">
                <i class="bi bi-send"></i> Publish Now
            </button>
        `;
    } else if (props.status === 'draft') {
        actionsDiv.innerHTML += `
            <button class="btn btn-warning btn-sm" onclick="editPost('${postId}')">
                <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-danger btn-sm" onclick="deletePost('${postId}')">
                <i class="bi bi-trash"></i> Delete
            </button>
            <button class="btn btn-primary btn-sm" onclick="scheduleDraft('${postId}')">
                <i class="bi bi-calendar-plus"></i> Schedule
            </button>
        `;
    }

    // Set edit button
    document.getElementById('editPostBtn').onclick = function() {
        editPost(postId);
    };

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('postDetailModal'));
    modal.show();
}

async function editPost(postId) {
    // In a real app, this would redirect to edit page
    // For now, we'll show a message
    alert(`Editing post ${postId}. In a real app, this would open an edit form.`);
    // window.location.href = `/edit/${postId}`;
}

async function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post?')) return;

    try {
        const response = await fetch(`/api/posts/${postId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            // Remove event from calendar
            const event = calendar.getEventById(postId);
            if (event) event.remove();

            // Remove from allEvents
            allEvents = allEvents.filter(e => e.id !== postId);

            // Update stats
            updateStats();

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('postDetailModal')).hide();

            alert('Post deleted successfully!');
        } else {
            throw new Error('Failed to delete post');
        }
    } catch (error) {
        console.error('Error deleting post:', error);
        alert('Failed to delete post. Please try again.');
    }
}

async function duplicatePost(postId) {
    const event = calendar.getEventById(postId);
    if (!event) return;

    if (confirm('Duplicate this post?')) {
        try {
            const response = await fetch('/api/posts/duplicate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ post_id: postId })
            });

            if (response.ok) {
                const newPost = await response.json();
                // Reload posts
                await loadPosts();
                alert('Post duplicated successfully!');
            } else {
                throw new Error('Failed to duplicate post');
            }
        } catch (error) {
            console.error('Error duplicating post:', error);
            alert('Failed to duplicate post. Please try again.');
        }
    }
}

async function publishNow(postId) {
    if (!confirm('Publish this post now?')) return;

    try {
        const response = await fetch(`/api/posts/${postId}/publish`, {
            method: 'POST'
        });

        if (response.ok) {
            // Update event
            const event = calendar.getEventById(postId);
            if (event) {
                event.setExtendedProp('status', 'published');
                event.setProp('className', `fc-event ${event.extendedProps.platform} published`);
            }

            // Update stats
            updateStats();

            alert('Post published successfully!');
        } else {
            throw new Error('Failed to publish post');
        }
    } catch (error) {
        console.error('Error publishing post:', error);
        alert('Failed to publish post. Please try again.');
    }
}

async function scheduleDraft(postId) {
    // This would open a schedule modal for the draft
    alert(`Scheduling draft ${postId}. In a real app, this would open a schedule form.`);
}

async function updatePostSchedule(postId, newDate) {
    try {
        const response = await fetch(`/api/posts/${postId}/schedule`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                scheduled_time: newDate.toISOString()
            })
        });

        if (!response.ok) {
            throw new Error('Failed to update schedule');
        }

        alert('Post schedule updated!');
    } catch (error) {
        console.error('Error updating schedule:', error);
        alert('Failed to update schedule. Reverting...');
        // Revert the drag
        loadPosts();
    }
}

function showBulkActions() {
    const modal = new bootstrap.Modal(document.getElementById('bulkActionsModal'));
    modal.show();
}

function executeBulkAction() {
    const action = document.getElementById('bulkAction').value;
    const platform = document.getElementById('bulkPlatform').value;
    const startDate = document.getElementById('bulkStartDate').value;
    const endDate = document.getElementById('bulkEndDate').value;

    alert(`Executing ${action} for ${platform} posts from ${startDate} to ${endDate}`);

    // In a real app, this would make an API call
    // For now, just close the modal
    bootstrap.Modal.getInstance(document.getElementById('bulkActionsModal')).hide();
}

// Export calendar
function exportCalendar() {
    const events = calendar.getEvents();
    const exportData = events.map(event => ({
        title: event.title,
        platform: event.extendedProps.platform,
        status: event.extendedProps.status,
        scheduled_time: event.start,
        content: event.extendedProps.content
    }));

    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

    const exportFileDefaultName = `calendar-export-${new Date().toISOString().split('T')[0]}.json`;

    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}

// Print calendar
function printCalendar() {
    window.print();
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+F to focus search
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('searchPosts').focus();
    }

    // Ctrl+N to schedule new post
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        window.location.href = "{{ url_for('main.schedule_post') }}";
    }

    // Escape to clear search
    if (e.key === 'Escape') {
        document.getElementById('searchPosts').value = '';
        filterCalendar();
    }
});
</script>
{% endblock %}